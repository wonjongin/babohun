import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
import json
import os

# í•œê¸€ í°íŠ¸ ì„¤ì •
plt.rcParams['font.family'] = 'Pretendard'
plt.rcParams['axes.unicode_minus'] = False

print("=== ì „êµ­ í‰ê·  ë³‘ìƒ ë¶„ë°° ë¶„ì„ ===")
print("ğŸ“Š ë³‘ì›ë³„ ìµœì í™” ê²°ê³¼ë¥¼ ì „êµ­ í‰ê·  ê´€ì ì—ì„œ ë¶„ì„")
print()

# --------------------------------------------------
# 1) ë°ì´í„° ë¡œë“œ
# --------------------------------------------------
print("1/4: ë°ì´í„° ë¡œë“œ ì¤‘...")

# ë³‘ì›ë³„ ìµœì í™” ê²°ê³¼ ë¡œë“œ
results_df = pd.read_csv('optimization_results_ë³‘ìƒ_ë¶„ë°°_ìµœì í™”_ë³‘ì›ê¸°ì¤€/ë³‘ìƒ_ë¶„ë°°_ìµœì í™”_ê²°ê³¼.csv')

print(f"âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ: {len(results_df)}ê°œ ë³‘ì›")
print()

# --------------------------------------------------
# 2) ì „êµ­ í‰ê·  ë¶„ì„
# --------------------------------------------------
print("2/4: ì „êµ­ í‰ê·  ë¶„ì„ ì¤‘...")

# ì „êµ­ í‰ê·  ê³„ì‚°
ì „êµ­_ì´ë³‘ìƒìˆ˜ = results_df['í˜„ì¬ë³‘ìƒìˆ˜'].sum()
ì „êµ­_ì´ì˜ˆì¸¡í™˜ììˆ˜ = results_df['ì˜ˆì¸¡í™˜ììˆ˜'].sum()
ì „êµ­_í‰ê· ë³‘ìƒê°€ë™ë¥  = (ì „êµ­_ì´ì˜ˆì¸¡í™˜ììˆ˜ / 365 / ì „êµ­_ì´ë³‘ìƒìˆ˜) * 100

# ìµœì í™” í›„ ì „êµ­ í‰ê· 
ì „êµ­_ìµœì ì´ë³‘ìƒìˆ˜ = results_df['ìµœì ë³‘ìƒìˆ˜'].sum()
ì „êµ­_ìµœì í‰ê· ë³‘ìƒê°€ë™ë¥  = (ì „êµ­_ì´ì˜ˆì¸¡í™˜ììˆ˜ / 365 / ì „êµ­_ìµœì ì´ë³‘ìƒìˆ˜) * 100

# ë³‘ìƒ ë³€í™”ëŸ‰ ë¶„ì„
ì´ë³€í™”ëŸ‰ = results_df['ë³€í™”ëŸ‰'].sum()
ì¦ê°€ë³‘ì›ìˆ˜ = len(results_df[results_df['ë³€í™”ëŸ‰'] > 0])
ê°ì†Œë³‘ì›ìˆ˜ = len(results_df[results_df['ë³€í™”ëŸ‰'] < 0])
ë³€í™”ì—†ìŒë³‘ì›ìˆ˜ = len(results_df[results_df['ë³€í™”ëŸ‰'] == 0])

# ê°€ë™ë¥  ê°œì„  ë¶„ì„
ê°€ë™ë¥ _ê°œì„ _ë³‘ì›ìˆ˜ = len(results_df[results_df['ìµœì _ë³‘ìƒê°€ë™ë¥ '] > results_df['í˜„ì¬_ë³‘ìƒê°€ë™ë¥ ']])
ê°€ë™ë¥ _ì•…í™”_ë³‘ì›ìˆ˜ = len(results_df[results_df['ìµœì _ë³‘ìƒê°€ë™ë¥ '] < results_df['í˜„ì¬_ë³‘ìƒê°€ë™ë¥ ']])
ê°€ë™ë¥ _ë™ì¼_ë³‘ì›ìˆ˜ = len(results_df[results_df['ìµœì _ë³‘ìƒê°€ë™ë¥ '] == results_df['í˜„ì¬_ë³‘ìƒê°€ë™ë¥ ']])

print(f"âœ… ì „êµ­ í‰ê·  ë¶„ì„ ì™„ë£Œ")
print(f"  - ì „êµ­ ì´ ë³‘ìƒ ìˆ˜: {ì „êµ­_ì´ë³‘ìƒìˆ˜:,.0f}ê°œ")
print(f"  - ì „êµ­ ì´ ì˜ˆì¸¡ í™˜ì ìˆ˜: {ì „êµ­_ì´ì˜ˆì¸¡í™˜ììˆ˜:,.0f}ëª…")
print(f"  - ì „êµ­ í‰ê·  ë³‘ìƒê°€ë™ë¥ : {ì „êµ­_í‰ê· ë³‘ìƒê°€ë™ë¥ :.2f}%")
print(f"  - ìµœì í™” í›„ í‰ê·  ë³‘ìƒê°€ë™ë¥ : {ì „êµ­_ìµœì í‰ê· ë³‘ìƒê°€ë™ë¥ :.2f}%")
print(f"  - ì´ ë³‘ìƒ ë³€í™”ëŸ‰: {ì´ë³€í™”ëŸ‰:,.0f}ê°œ")
print()

# --------------------------------------------------
# 3) ìƒì„¸ ë¶„ì„
# --------------------------------------------------
print("3/4: ìƒì„¸ ë¶„ì„ ì¤‘...")

# ë³‘ìƒ ê·œëª¨ë³„ ë¶„ì„
results_df['ë³‘ìƒê·œëª¨'] = pd.cut(results_df['í˜„ì¬ë³‘ìƒìˆ˜'], 
                              bins=[0, 100, 300, 500, 1000, float('inf')],
                              labels=['ì†Œí˜•(100â†“)', 'ì¤‘ì†Œí˜•(100-300)', 'ì¤‘í˜•(300-500)', 'ëŒ€í˜•(500-1000)', 'ì´ˆëŒ€í˜•(1000â†‘)'])

ê·œëª¨ë³„_ë¶„ì„ = results_df.groupby('ë³‘ìƒê·œëª¨').agg({
    'í˜„ì¬ë³‘ìƒìˆ˜': ['count', 'sum', 'mean'],
    'ìµœì ë³‘ìƒìˆ˜': ['sum', 'mean'],
    'ë³€í™”ëŸ‰': ['sum', 'mean'],
    'í˜„ì¬_ë³‘ìƒê°€ë™ë¥ ': 'mean',
    'ìµœì _ë³‘ìƒê°€ë™ë¥ ': 'mean'
}).round(2)

# ì§€ì—­ë³„ ë¶„ì„ (ë³‘ì›ëª…ì—ì„œ ì§€ì—­ ì¶”ì¶œ)
results_df['ì§€ì—­'] = results_df['ë³‘ì›ëª…'].str.extract(r'^([ê°€-í£]+)')[0]

ì§€ì—­ë³„_ë¶„ì„ = results_df.groupby('ì§€ì—­').agg({
    'í˜„ì¬ë³‘ìƒìˆ˜': ['count', 'sum', 'mean'],
    'ìµœì ë³‘ìƒìˆ˜': ['sum', 'mean'],
    'ë³€í™”ëŸ‰': ['sum', 'mean'],
    'í˜„ì¬_ë³‘ìƒê°€ë™ë¥ ': 'mean',
    'ìµœì _ë³‘ìƒê°€ë™ë¥ ': 'mean'
}).round(2)

print(f"âœ… ìƒì„¸ ë¶„ì„ ì™„ë£Œ")
print()

# --------------------------------------------------
# 4) ê²°ê³¼ ì €ì¥ ë° ì‹œê°í™”
# --------------------------------------------------
print("4/4: ê²°ê³¼ ì €ì¥ ë° ì‹œê°í™” ì¤‘...")

# ê²°ê³¼ ì €ì¥ ë””ë ‰í† ë¦¬ ìƒì„±
results_dir = "optimization_results_ì „êµ­í‰ê· _ë¶„ì„"
os.makedirs(results_dir, exist_ok=True)

# 1) ì „êµ­ í‰ê·  ìš”ì•½ ì €ì¥
summary_stats = {
    "timestamp": datetime.now().isoformat(),
    "ì „êµ­_ì´ë³‘ìƒìˆ˜": int(ì „êµ­_ì´ë³‘ìƒìˆ˜),
    "ì „êµ­_ì´ì˜ˆì¸¡í™˜ììˆ˜": int(ì „êµ­_ì´ì˜ˆì¸¡í™˜ììˆ˜),
    "ì „êµ­_í‰ê· ë³‘ìƒê°€ë™ë¥ ": float(ì „êµ­_í‰ê· ë³‘ìƒê°€ë™ë¥ ),
    "ì „êµ­_ìµœì í‰ê· ë³‘ìƒê°€ë™ë¥ ": float(ì „êµ­_ìµœì í‰ê· ë³‘ìƒê°€ë™ë¥ ),
    "ì´ë³€í™”ëŸ‰": int(ì´ë³€í™”ëŸ‰),
    "ì¦ê°€ë³‘ì›ìˆ˜": int(ì¦ê°€ë³‘ì›ìˆ˜),
    "ê°ì†Œë³‘ì›ìˆ˜": int(ê°ì†Œë³‘ì›ìˆ˜),
    "ë³€í™”ì—†ìŒë³‘ì›ìˆ˜": int(ë³€í™”ì—†ìŒë³‘ì›ìˆ˜),
    "ê°€ë™ë¥ _ê°œì„ _ë³‘ì›ìˆ˜": int(ê°€ë™ë¥ _ê°œì„ _ë³‘ì›ìˆ˜),
    "ê°€ë™ë¥ _ì•…í™”_ë³‘ì›ìˆ˜": int(ê°€ë™ë¥ _ì•…í™”_ë³‘ì›ìˆ˜),
    "ê°€ë™ë¥ _ë™ì¼_ë³‘ì›ìˆ˜": int(ê°€ë™ë¥ _ë™ì¼_ë³‘ì›ìˆ˜),
    "ì´ë³‘ì›ìˆ˜": int(len(results_df))
}

with open(f"{results_dir}/ì „êµ­í‰ê· _ìš”ì•½.json", 'w', encoding='utf-8') as f:
    json.dump(summary_stats, f, ensure_ascii=False, indent=2)

# 2) ê·œëª¨ë³„ ë¶„ì„ ì €ì¥
ê·œëª¨ë³„_ë¶„ì„.to_csv(f"{results_dir}/ê·œëª¨ë³„_ë¶„ì„.csv", encoding='utf-8-sig')

# 3) ì§€ì—­ë³„ ë¶„ì„ ì €ì¥
ì§€ì—­ë³„_ë¶„ì„.to_csv(f"{results_dir}/ì§€ì—­ë³„_ë¶„ì„.csv", encoding='utf-8-sig')

# 4) ì‹œê°í™”
plt.figure(figsize=(20, 12))

# ì„œë¸Œí”Œë¡¯ 1: ì „êµ­ í‰ê·  ë³‘ìƒê°€ë™ë¥  ë¹„êµ
plt.subplot(2, 3, 1)
labels = ['í˜„ì¬', 'ìµœì í™” í›„']
values = [ì „êµ­_í‰ê· ë³‘ìƒê°€ë™ë¥ , ì „êµ­_ìµœì í‰ê· ë³‘ìƒê°€ë™ë¥ ]
colors = ['lightcoral', 'lightblue']
bars = plt.bar(labels, values, color=colors, alpha=0.7)
plt.ylabel('ë³‘ìƒê°€ë™ë¥  (%)')
plt.title('ì „êµ­ í‰ê·  ë³‘ìƒê°€ë™ë¥  ë¹„êµ')
plt.grid(True, alpha=0.3)
for bar, value in zip(bars, values):
    plt.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.5, 
             f'{value:.1f}%', ha='center', va='bottom')

# ì„œë¸Œí”Œë¡¯ 2: ë³‘ìƒ ë³€í™”ëŸ‰ ë¶„í¬
plt.subplot(2, 3, 2)
plt.hist(results_df['ë³€í™”ëŸ‰'], bins=15, alpha=0.7, color='skyblue', edgecolor='black')
plt.xlabel('ë³‘ìƒ ìˆ˜ ë³€í™”ëŸ‰')
plt.ylabel('ë³‘ì› ìˆ˜')
plt.title('ë³‘ìƒ ìˆ˜ ë³€í™”ëŸ‰ ë¶„í¬')
plt.axvline(x=0, color='red', linestyle='--', alpha=0.7)
plt.grid(True, alpha=0.3)

# ì„œë¸Œí”Œë¡¯ 3: ë³‘ìƒ ê·œëª¨ë³„ í‰ê·  ë³€í™”ëŸ‰
plt.subplot(2, 3, 3)
ê·œëª¨ë³„_ë³€í™”ëŸ‰ = results_df.groupby('ë³‘ìƒê·œëª¨')['ë³€í™”ëŸ‰'].mean().sort_values(ascending=True)
plt.barh(ê·œëª¨ë³„_ë³€í™”ëŸ‰.index.astype(str), ê·œëª¨ë³„_ë³€í™”ëŸ‰.values, alpha=0.7, color='lightgreen')
plt.xlabel('í‰ê·  ë³€í™”ëŸ‰')
plt.title('ë³‘ìƒ ê·œëª¨ë³„ í‰ê·  ë³€í™”ëŸ‰')
plt.axvline(x=0, color='red', linestyle='--', alpha=0.7)
plt.grid(True, alpha=0.3)

# ì„œë¸Œí”Œë¡¯ 4: ì§€ì—­ë³„ í‰ê·  ê°€ë™ë¥  ê°œì„ 
plt.subplot(2, 3, 4)
ì§€ì—­ë³„_ê°œì„  = results_df.groupby('ì§€ì—­').apply(
    lambda x: (x['ìµœì _ë³‘ìƒê°€ë™ë¥ '] - x['í˜„ì¬_ë³‘ìƒê°€ë™ë¥ ']).mean()
).sort_values(ascending=True)
plt.barh(ì§€ì—­ë³„_ê°œì„ .index.astype(str), ì§€ì—­ë³„_ê°œì„ .values, alpha=0.7, color='orange')
plt.xlabel('ê°€ë™ë¥  ê°œì„ ë„ (%)')
plt.title('ì§€ì—­ë³„ í‰ê·  ê°€ë™ë¥  ê°œì„ ')
plt.axvline(x=0, color='red', linestyle='--', alpha=0.7)
plt.grid(True, alpha=0.3)

# ì„œë¸Œí”Œë¡¯ 5: í˜„ì¬ vs ìµœì  ê°€ë™ë¥  ì‚°ì ë„
plt.subplot(2, 3, 5)
plt.scatter(results_df['í˜„ì¬_ë³‘ìƒê°€ë™ë¥ '], results_df['ìµœì _ë³‘ìƒê°€ë™ë¥ '], 
           alpha=0.6, c=results_df['ë³€í™”ëŸ‰'], cmap='RdYlBu')
plt.colorbar(label='ë³€í™”ëŸ‰')
max_util = max(results_df['í˜„ì¬_ë³‘ìƒê°€ë™ë¥ '].max(), results_df['ìµœì _ë³‘ìƒê°€ë™ë¥ '].max())
plt.plot([0, max_util], [0, max_util], 'r--', alpha=0.5)
plt.xlabel('í˜„ì¬ ë³‘ìƒê°€ë™ë¥  (%)')
plt.ylabel('ìµœì  ë³‘ìƒê°€ë™ë¥  (%)')
plt.title('í˜„ì¬ vs ìµœì  ê°€ë™ë¥  ë¹„êµ')
plt.grid(True, alpha=0.3)

# ì„œë¸Œí”Œë¡¯ 6: ë³‘ìƒ ê·œëª¨ë³„ ë³‘ì› ìˆ˜ ë¶„í¬
plt.subplot(2, 3, 6)
ê·œëª¨ë³„_ë³‘ì›ìˆ˜ = results_df['ë³‘ìƒê·œëª¨'].value_counts().sort_index()
plt.pie(ê·œëª¨ë³„_ë³‘ì›ìˆ˜.values, labels=ê·œëª¨ë³„_ë³‘ì›ìˆ˜.index.astype(str), autopct='%1.1f%%', 
        startangle=90, colors=plt.cm.tab10(np.linspace(0, 1, len(ê·œëª¨ë³„_ë³‘ì›ìˆ˜))))
plt.title('ë³‘ìƒ ê·œëª¨ë³„ ë³‘ì› ìˆ˜ ë¶„í¬')

plt.tight_layout()
plt.savefig(f"{results_dir}/ì „êµ­í‰ê· _ë¶„ì„_ì‹œê°í™”.png", dpi=300, bbox_inches='tight')
plt.show()

# 5) ìƒì„¸ ë¦¬í¬íŠ¸ ì¶œë ¥
print("\n" + "="*60)
print("ğŸ“Š ì „êµ­ í‰ê·  ë³‘ìƒ ë¶„ë°° ë¶„ì„ ê²°ê³¼")
print("="*60)

print(f"\nğŸ¯ ì „êµ­ ì „ì²´ í˜„í™©:")
print(f"  - ì´ ë³‘ì› ìˆ˜: {len(results_df):,}ê°œ")
print(f"  - ì´ ë³‘ìƒ ìˆ˜: {ì „êµ­_ì´ë³‘ìƒìˆ˜:,.0f}ê°œ")
print(f"  - ì´ ì˜ˆì¸¡ í™˜ì ìˆ˜: {ì „êµ­_ì´ì˜ˆì¸¡í™˜ììˆ˜:,.0f}ëª…")
print(f"  - í‰ê·  ë³‘ìƒê°€ë™ë¥ : {ì „êµ­_í‰ê· ë³‘ìƒê°€ë™ë¥ :.2f}% â†’ {ì „êµ­_ìµœì í‰ê· ë³‘ìƒê°€ë™ë¥ :.2f}%")

print(f"\nğŸ“ˆ ë³‘ìƒ ë³€í™” í˜„í™©:")
print(f"  - ì´ ë³€í™”ëŸ‰: {ì´ë³€í™”ëŸ‰:,.0f}ê°œ")
print(f"  - ì¦ê°€ ë³‘ì›: {ì¦ê°€ë³‘ì›ìˆ˜}ê°œ")
print(f"  - ê°ì†Œ ë³‘ì›: {ê°ì†Œë³‘ì›ìˆ˜}ê°œ")
print(f"  - ë³€í™” ì—†ìŒ: {ë³€í™”ì—†ìŒë³‘ì›ìˆ˜}ê°œ")

print(f"\nğŸ¥ ê°€ë™ë¥  ê°œì„  í˜„í™©:")
print(f"  - ê°œì„  ë³‘ì›: {ê°€ë™ë¥ _ê°œì„ _ë³‘ì›ìˆ˜}ê°œ")
print(f"  - ì•…í™” ë³‘ì›: {ê°€ë™ë¥ _ì•…í™”_ë³‘ì›ìˆ˜}ê°œ")
print(f"  - ë™ì¼ ë³‘ì›: {ê°€ë™ë¥ _ë™ì¼_ë³‘ì›ìˆ˜}ê°œ")

print(f"\nğŸ“‹ ê·œëª¨ë³„ ë¶„ì„:")
print(ê·œëª¨ë³„_ë¶„ì„[['í˜„ì¬ë³‘ìƒìˆ˜', 'ë³€í™”ëŸ‰', 'í˜„ì¬_ë³‘ìƒê°€ë™ë¥ ', 'ìµœì _ë³‘ìƒê°€ë™ë¥ ']].round(2))

print(f"\nğŸŒ ì§€ì—­ë³„ ë¶„ì„:")
print(ì§€ì—­ë³„_ë¶„ì„[['í˜„ì¬ë³‘ìƒìˆ˜', 'ë³€í™”ëŸ‰', 'í˜„ì¬_ë³‘ìƒê°€ë™ë¥ ', 'ìµœì _ë³‘ìƒê°€ë™ë¥ ']].round(2))

print(f"\nâœ… ëª¨ë“  ê²°ê³¼ê°€ {results_dir}/ ë””ë ‰í† ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
print("="*60) 